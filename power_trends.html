<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Optical Power Trends</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }
        .header {
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        select, input, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        .interface-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .interface-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }
        .interface-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .interface-card.selected {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        .interface-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .interface-details {
            font-size: 13px;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #666;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            min-width: 150px;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                <button onclick="window.location.href='/'" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">← Back to Main</button>
                <h1 style="margin: 0;">Optical Power Trends</h1>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>Time Range:</label>
                    <select id="timeRange">
                        <option value="1">Last 1 Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="168">Last 7 Days</option>
                        <option value="720">Last 30 Days</option>
                    </select>
                </div>
                <button onclick="loadInterfaces()">Refresh Interfaces</button>
                <button onclick="loadPowerHistory()" id="loadDataBtn" disabled>Load Power Data</button>
            </div>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">Loading optical interfaces...</div>
            <div id="interfaceList" class="interface-list" style="display: none;"></div>
            
            <div id="chartsSection" style="display: none;">
                <div class="stats" id="statsSection"></div>
                
                <div class="chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
            
            <div id="noData" class="no-data" style="display: none;">
                No optical interfaces found or no power data available.<br>
                Make sure to run an SSH scan on devices with optical transceivers first.
            </div>
        </div>
    </div>

    <script>
        let selectedInterfaces = new Set();
        let powerChart = null;
        let temperatureChart = null;
        let allInterfaces = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadInterfaces();
        });

        async function loadInterfaces() {
            const urlParams = new URLSearchParams(window.location.search);
            const ipsParam = urlParams.get('ips');
            let ipList = [];
            
            try {
                ipList = JSON.parse(decodeURIComponent(ipsParam || '[]'));
            } catch (e) {
                ipList = [];
            }

            if (ipList.length === 0) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/power_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ip_list: ipList,
                        hours: 1  // Just to get interfaces
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Get unique interfaces from history
                const interfaceMap = new Map();
                data.history.forEach(reading => {
                    const key = `${reading.ip_address}:${reading.interface_index}`;
                    if (!interfaceMap.has(key)) {
                        interfaceMap.set(key, {
                            ip_address: reading.ip_address,
                            interface_index: reading.interface_index,
                            interface_name: reading.interface_name,
                            cli_port: reading.cli_port,
                            has_data: true
                        });
                    }
                });
                
                allInterfaces = Array.from(interfaceMap.values());
                
                if (allInterfaces.length === 0) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('noData').style.display = 'block';
                    return;
                }
                
                displayInterfaces();
                
            } catch (error) {
                document.getElementById('loading').textContent = 'Error: ' + error.message;
            }
        }

        function displayInterfaces() {
            const container = document.getElementById('interfaceList');
            container.innerHTML = '';
            
            allInterfaces.forEach(iface => {
                const card = document.createElement('div');
                card.className = 'interface-card';
                card.innerHTML = `
                    <div class="interface-name">${iface.interface_name}</div>
                    <div class="interface-details">
                        IP: ${iface.ip_address}<br>
                        Port: ${iface.cli_port}<br>
                        ${iface.has_data ? '✓ Has power data' : 'No data'}
                    </div>
                `;
                
                card.onclick = () => toggleInterface(iface, card);
                container.appendChild(card);
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('interfaceList').style.display = 'grid';
        }

        function toggleInterface(iface, card) {
            const key = `${iface.ip_address}:${iface.interface_index}`;
            
            if (selectedInterfaces.has(key)) {
                selectedInterfaces.delete(key);
                card.classList.remove('selected');
            } else {
                selectedInterfaces.add(key);
                card.classList.add('selected');
            }
            
            document.getElementById('loadDataBtn').disabled = selectedInterfaces.size === 0;
        }

        async function loadPowerHistory() {
            console.log('loadPowerHistory called');
            console.log('Selected interfaces:', selectedInterfaces);
            
            if (selectedInterfaces.size === 0) {
                console.log('No interfaces selected, returning');
                alert('Please select at least one interface first');
                return;
            }
            
            document.getElementById('loadDataBtn').disabled = true;
            document.getElementById('loadDataBtn').textContent = 'Loading...';
            
            const hours = parseInt(document.getElementById('timeRange').value);
            const urlParams = new URLSearchParams(window.location.search);
            const ipsParam = urlParams.get('ips');
            let ipList = [];
            
            try {
                ipList = JSON.parse(decodeURIComponent(ipsParam || '[]'));
                console.log('IP list from URL:', ipList);
            } catch (e) {
                console.error('Error parsing IP list:', e);
                ipList = [];
            }
            
            try {
                console.log('Making API call to /power_history');
                const response = await fetch('/power_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ip_list: ipList,
                        hours: hours
                    })
                });
                
                console.log('API response status:', response.status);
                const data = await response.json();
                console.log('API response data:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Filter data for selected interfaces
                const filteredData = data.history.filter(reading => {
                    const key = `${reading.ip_address}:${reading.interface_index}`;
                    return selectedInterfaces.has(key);
                });
                
                console.log('Filtered data count:', filteredData.length);
                console.log('Sample filtered data:', filteredData.slice(0, 2));
                
                if (filteredData.length === 0) {
                    alert('No power data found for selected interfaces in the specified time range');
                    return;
                }
                
                console.log('Calling displayCharts...');
                displayCharts(filteredData);
                
            } catch (error) {
                alert('Error loading power data: ' + error.message);
            } finally {
                document.getElementById('loadDataBtn').disabled = false;
                document.getElementById('loadDataBtn').textContent = 'Load Power Data';
            }
        }

        function displayCharts(data) {
            console.log('displayCharts called with', data.length, 'records');
            document.getElementById('chartsSection').style.display = 'block';
            console.log('Charts section display set to block');
            
            // Group data by interface
            const interfaceData = {};
            data.forEach(reading => {
                const key = `${reading.interface_name} (${reading.ip_address})`;
                if (!interfaceData[key]) {
                    interfaceData[key] = {
                        labels: [],
                        txPower: [],
                        rxPower: [],
                        temperature: []
                    };
                }
                
                // Convert timestamp to Date object for better formatting
                const timestamp = new Date(reading.measurement_timestamp);
                interfaceData[key].labels.push(timestamp);
                interfaceData[key].txPower.push(reading.tx_power);
                interfaceData[key].rxPower.push(reading.rx_power);
                interfaceData[key].temperature.push(reading.temperature);
            });
            
            console.log('Grouped data for', Object.keys(interfaceData).length, 'interfaces');
            console.log('Interface keys:', Object.keys(interfaceData));
            
            // Create power chart
            console.log('Creating power chart...');
            const powerCtx = document.getElementById('powerChart').getContext('2d');
            
            if (powerChart) {
                console.log('Destroying existing power chart');
                powerChart.destroy();
            }
            
            const datasets = [];
            Object.keys(interfaceData).forEach((iface, index) => {
                console.log('Adding dataset for:', iface);
                const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
                const color = colors[index % colors.length];
                
                // TX Power dataset
                datasets.push({
                    label: `${iface} - TX Power`,
                    data: interfaceData[iface].txPower,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    yAxisID: 'y'
                });
                
                // RX Power dataset
                datasets.push({
                    label: `${iface} - RX Power`,
                    data: interfaceData[iface].rxPower,
                    borderColor: color,
                    backgroundColor: color + '40',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    yAxisID: 'y'
                });
            });
            
            powerChart = new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: interfaceData[Object.keys(interfaceData)[0]].labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Optical Transceiver Power Levels',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleString();
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' dBm';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'MMM dd HH:mm',
                                    minute: 'HH:mm'
                                },
                                tooltipFormat: 'MMM dd, yyyy HH:mm:ss'
                            },
                            title: {
                                display: true,
                                text: 'Measurement Time',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Optical Power (dBm)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + ' dBm';
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('Power chart created successfully');
            
            // Scroll to charts section
            document.getElementById('chartsSection').scrollIntoView({ behavior: 'smooth' });
            
            // Create temperature chart if data available
            const hasTempData = Object.values(interfaceData).some(d => d.temperature.some(t => t !== null));
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            
            if (temperatureChart) {
                temperatureChart.destroy();
            }
            
            if (hasTempData) {
                const tempDatasets = [];
                Object.keys(interfaceData).forEach((iface, index) => {
                    const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
                    const color = colors[index % colors.length];
                    
                    tempDatasets.push({
                        label: `${iface} - Temperature`,
                        data: interfaceData[iface].temperature,
                        borderColor: color,
                        backgroundColor: color + '20',
                        yAxisID: 'y',
                        tension: 0.1
                    });
                });
                
                temperatureChart = new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: interfaceData[Object.keys(interfaceData)[0]].labels,
                        datasets: tempDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    displayFormats: {
                                        hour: 'MMM dd HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            }
                        }
                    }
                });
                
                document.getElementById('temperatureChart').parentElement.style.display = 'block';
            } else {
                document.getElementById('temperatureChart').parentElement.style.display = 'none';
            }
            
            // Display statistics
            displayStats(data);
        }

        function displayStats(data) {
            const statsContainer = document.getElementById('statsSection');
            statsContainer.innerHTML = '';
            
            // Calculate stats per interface
            const interfaceStats = {};
            data.forEach(reading => {
                const key = `${reading.interface_name} (${reading.ip_address})`;
                if (!interfaceStats[key]) {
                    interfaceStats[key] = {
                        txValues: [],
                        rxValues: [],
                        tempValues: []
                    };
                }
                
                if (reading.tx_power !== null) interfaceStats[key].txValues.push(reading.tx_power);
                if (reading.rx_power !== null) interfaceStats[key].rxValues.push(reading.rx_power);
                if (reading.temperature !== null) interfaceStats[key].tempValues.push(reading.temperature);
            });
            
            Object.keys(interfaceStats).forEach(iface => {
                const stats = interfaceStats[iface];
                
                if (stats.txValues.length > 0) {
                    const txAvg = (stats.txValues.reduce((a, b) => a + b, 0) / stats.txValues.length).toFixed(2);
                    const txMin = Math.min(...stats.txValues).toFixed(2);
                    const txMax = Math.max(...stats.txValues).toFixed(2);
                    
                    statsContainer.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">${iface} - TX Power</div>
                            <div class="stat-value">${txAvg} dBm</div>
                            <div style="font-size: 11px; color: #888;">
                                Min: ${txMin} dBm | Max: ${txMax} dBm
                            </div>
                        </div>
                    `;
                }
                
                if (stats.rxValues.length > 0) {
                    const rxAvg = (stats.rxValues.reduce((a, b) => a + b, 0) / stats.rxValues.length).toFixed(2);
                    const rxMin = Math.min(...stats.rxValues).toFixed(2);
                    const rxMax = Math.max(...stats.rxValues).toFixed(2);
                    
                    statsContainer.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-label">${iface} - RX Power</div>
                            <div class="stat-value">${rxAvg} dBm</div>
                            <div style="font-size: 11px; color: #888;">
                                Min: ${rxMin} dBm | Max: ${rxMax} dBm
                            </div>
                        </div>
                    `;
                }
            });
        }
    </script>
</body>
</html>
