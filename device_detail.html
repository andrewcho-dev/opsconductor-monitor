<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Device Details</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 8px; font-size: 11px; }
        .header { margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
        .header h1 { margin: 0; font-size: 16px; }
        .header-buttons { display: flex; gap: 6px; }
        .top-layout { display: flex; gap: 10px; align-items: flex-start; margin-bottom: 10px; }
        .top-layout .device-info,
        .top-layout .snmp-section { flex: 1 1 0; }
        .device-info { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 0; }
        .device-info h2 { margin: 0 0 6px 0; font-size: 14px; }
        .section { margin-bottom: 14px; }
        .section h3 { color: #007bff; border-bottom: 1px solid #007bff; padding-bottom: 3px; margin: 0 0 6px 0; font-size: 13px; }
        .info-grid { display: grid; grid-template-columns: 160px 1fr; gap: 4px 8px; margin-bottom: 6px; }
        .info-label { font-weight: bold; color: #495057; }
        .info-value { color: #212529; }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        .btn { background-color: #007bff; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin: 2px; font-size: 10px; }
        .btn:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #545b62; }
        .loading { text-align: center; color: #6c757d; font-style: italic; }
        .error { color: #dc3545; font-weight: bold; }
        .placeholder { color: #6c757d; font-style: italic; }
        table { border-collapse: collapse; width: 100%; font-size: 10px; margin-top: 6px; }
        th, td { border: 1px solid #ddd; padding: 4px 6px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        
        /* Numeric column alignment - align first digits and decimal points */
        .numeric-align { text-align: right; font-family: 'Courier New', monospace; }
        .speed-align { text-align: right; font-family: 'Courier New', monospace; min-width: 80px; }
        .bytes-align { text-align: right; font-family: 'Courier New', monospace; min-width: 90px; }
        .power-align { text-align: right; font-family: 'Courier New', monospace; min-width: 70px; }
        .optical-icon { cursor: pointer; color: #007bff; font-size: 14px; text-align: center; }
        .optical-icon:hover { color: #0056b3; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 2% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 1200px; max-height: 90%; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .chart-container { height: 400px; margin: 20px 0; }
        .data-table { margin-top: 20px; border-collapse: collapse; width: 100%; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #f2f2f2; }
        .numeric { text-align: right; font-family: 'Courier New', monospace; }

        @media (max-width: 900px) {
            .top-layout { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Device Details</h1>
        <div class="header-buttons">
            <button class="btn btn-secondary" onclick="window.close()">Close</button>
            <button class="btn" onclick="refreshData()">Refresh</button>
        </div>
    </div>

    <div class="top-layout">
        <div class="device-info">
            <h2 id="deviceTitle">Loading...</h2>
            <div class="info-grid">
                <div class="info-label">IP Address:</div>
                <div class="info-value" id="ipAddress">-</div>
                
                <div class="info-label">Hostname:</div>
                <div class="info-value" id="hostname">-</div>
                
                <div class="info-label">Ping Status:</div>
                <div class="info-value" id="pingStatus">-</div>
                
                <div class="info-label">SNMP Status:</div>
                <div class="info-value" id="snmpStatus">-</div>
                
                <div class="info-label">Last Scan:</div>
                <div class="info-value" id="lastScan">-</div>
            </div>
        </div>

        <div class="section snmp-section">
            <h3>SNMP System Information</h3>
            <div class="info-grid">
                <div class="info-label">Vendor:</div>
                <div class="info-value" id="snmpVendorName">-</div>

                <div class="info-label">Model:</div>
                <div class="info-value" id="snmpModel">-</div>

                <div class="info-label">Description:</div>
                <div class="info-value" id="snmpDescription">-</div>
                
                <div class="info-label">Contact:</div>
                <div class="info-value" id="snmpContact">-</div>
                
                <div class="info-label">Location:</div>
                <div class="info-value" id="snmpLocation">-</div>
                
                <div class="info-label">Uptime:</div>
                <div class="info-value" id="snmpUptime">-</div>
                
                <div class="info-label">Chassis MAC:</div>
                <div class="info-value" id="snmpChassisMac">-</div>

                <div class="info-label">Vendor OID:</div>
                <div class="info-value" id="snmpVendorOid">-</div>

                <div class="info-label">Serial Number:</div>
                <div class="info-value" id="snmpSerial">-</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>Interface Information</h3>
        <div id="interfaceInfo" class="loading">
            Loading interface data...
        </div>
        <button class="btn" onclick="loadInterfaceData()">Load Interfaces</button>
        <button class="btn" onclick="storeInterfaceData()">Store Current Data</button>
        <table id="interfaceTable" style="display: none;">
            <thead>
                <tr>
                    <th>Port</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th class="speed-align">Speed</th>
                    <th>Status</th>
                    <th>MAC Address</th>
                    <th class="bytes-align">RX Bytes</th>
                    <th class="bytes-align">TX Bytes</th>
                    <th>Medium</th>
                    <th>Connector</th>
                    <th class="power-align">TX Power</th>
                    <th class="power-align">RX Power</th>
                    <th class="power-align">Temperature</th>
                    <th>LLDP Neighbor</th>
                    <th>LLDP Remote Port</th>
                    <th>Optical History</th>
                </tr>
            </thead>
            <tbody id="interfaceTableBody">
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>Port Information</h3>
        <div id="portInfo" class="loading">
            Port scanning feature coming soon...
        </div>
        <table id="portTable" style="display: none;">
            <thead>
                <tr>
                    <th>Port</th>
                    <th>Protocol</th>
                    <th>Status</th>
                    <th>Service</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="portTableBody">
            </tbody>
        </table>
    </div>

    <div class="section">
        <h3>Scan History</h3>
        <div id="scanHistory" class="loading">
            Loading scan history...
        </div>
        <table id="historyTable" style="display: none;">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Ping Status</th>
                    <th>SNMP Status</th>
                    <th>Response Time</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
            </tbody>
        </table>
    </div>

    <!-- Optical Power History Modal -->
    <div id="opticalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOpticalModal()">&times;</span>
            <h2 id="modalTitle">Optical Transceiver Power History</h2>
            
            <!-- Time Range Selector -->
            <div style="margin: 20px 0; text-align: center;">
                <label style="font-weight: bold; margin-right: 10px;">Time Range:</label>
                <button class="btn" onclick="loadOpticalHistory(1)">1hr</button>
                <button class="btn" onclick="loadOpticalHistory(12)">12hr</button>
                <button class="btn" onclick="loadOpticalHistory(24)">1day</button>
                <button class="btn" onclick="loadOpticalHistory(168)">7day</button>
                <button class="btn" onclick="loadOpticalHistory(720)">30day</button>
                <button class="btn" onclick="loadOpticalHistory(2160)">90day</button>
                <button class="btn" onclick="loadOpticalHistory(4320)">180day</button>
                <button class="btn" onclick="loadOpticalHistory(8640)">360day</button>
                <button class="btn" onclick="loadOpticalHistory(17280)">720day</button>
                <button class="btn" onclick="loadOpticalHistory(34560)">1440day</button>
            </div>
            
            <div class="chart-container">
                <canvas id="opticalChart"></canvas>
            </div>
            
            <h3>Power Readings</h3>
            <table id="powerDataTable" class="data-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>TX Power (dBm)</th>
                        <th>RX Power (dBm)</th>
                        <th>Temperature (Â°C)</th>
                    </tr>
                </thead>
                <tbody id="powerDataTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="/static/interface-display-module.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        let deviceIP = '';
        let currentOpticalInterface = null; // Store current interface for range changes
        
        // Get IP from URL parameter
        function getIPFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('ip');
        }
        
        // Load device data
        async function loadDeviceData() {
            deviceIP = getIPFromURL();
            if (!deviceIP) {
                document.getElementById('deviceTitle').textContent = 'No IP Address Specified';
                return;
            }
            
            document.getElementById('deviceTitle').textContent = `Device Details - ${deviceIP}`;
            document.getElementById('ipAddress').textContent = deviceIP;
            
            try {
                // Get device data from API
                const response = await fetch(`/data`);
                const allDevices = await response.json();
                const device = allDevices.find(d => d.ip_address === deviceIP);
                
                if (device) {
                    // Basic info
                    document.getElementById('hostname').textContent = device.snmp_hostname || 'No hostname available';
                    document.getElementById('lastScan').textContent = device.scan_timestamp || 'Never scanned';
                    
                    // Ping status
                    const pingElement = document.getElementById('pingStatus');
                    if (device.ping_status && device.ping_status.includes('online')) {
                        pingElement.innerHTML = '<span class="status-online">âœ“ Online</span>';
                    } else {
                        pingElement.innerHTML = '<span class="status-offline">âœ— Offline</span>';
                    }
                    
                    // SNMP status
                    const snmpElement = document.getElementById('snmpStatus');
                    if (device.snmp_status && device.snmp_status.includes('YES')) {
                        snmpElement.innerHTML = '<span class="status-online">âœ“ SNMP Available</span>';
                    } else {
                        snmpElement.innerHTML = '<span class="status-offline">âœ— SNMP Not Available</span>';
                    }
                    
                    // SNMP details
                    document.getElementById('snmpVendorName').textContent = device.snmp_vendor_name || (device.snmp_vendor_oid || 'Unknown');
                    document.getElementById('snmpModel').textContent = device.snmp_model || (device.snmp_description || 'Unknown');
                    document.getElementById('snmpDescription').textContent = device.snmp_description || 'No description available';
                    document.getElementById('snmpContact').textContent = device.snmp_contact || 'No contact information';
                    document.getElementById('snmpLocation').textContent = device.snmp_location || 'No location information';
                    document.getElementById('snmpUptime').textContent = device.snmp_uptime || 'No uptime information';
                    document.getElementById('snmpChassisMac').textContent = device.snmp_chassis_mac || 'No MAC address available';
                    document.getElementById('snmpVendorOid').textContent = device.snmp_vendor_oid || 'No vendor OID available';
                    document.getElementById('snmpSerial').textContent = device.snmp_serial || 'No serial number available';
                } else {
                    document.getElementById('deviceTitle').innerHTML = '<span class="error">Device Not Found</span>';
                }
                
                // Load scan history (placeholder for now)
                loadScanHistory();
                
            } catch (error) {
                console.error('Error loading device data:', error);
                document.getElementById('deviceTitle').innerHTML = '<span class="error">Error Loading Data</span>';
            }
        }
        
        // Load scan history (placeholder)
        function loadScanHistory() {
            const historyDiv = document.getElementById('scanHistory');
            historyDiv.innerHTML = '<p class="placeholder">Scan history feature coming soon...</p>';
        }
        
        // Load interface data
        async function loadInterfaceData() {
            if (!deviceIP) {
                alert('No device IP specified');
                return;
            }
            
            const interfaceDiv = document.getElementById('interfaceInfo');
            
            interfaceDiv.innerHTML = 'Loading interface data...';
            interfaceDiv.className = 'loading';
            
            try {
                // Get real-time interface data
                const interfaces = await InterfaceDisplayModule.getRealTimeInterfaceData(deviceIP);
                
                if (interfaces.length > 0) {
                    InterfaceDisplayModule.displayInterfaceData(interfaces);
                    interfaceDiv.innerHTML = `Found ${interfaces.length} interfaces`;
                    interfaceDiv.className = '';
                } else {
                    interfaceDiv.innerHTML = '<p class="error">No interface data available</p>';
                }
                
            } catch (error) {
                console.error('Error loading interface data:', error);
                interfaceDiv.innerHTML = '<p class="error">Error loading interface data</p>';
            }
        }
        
        // Store interface data
        async function storeInterfaceData() {
            if (!deviceIP) {
                alert('No device IP specified');
                return;
            }
            
            const interfaceDiv = document.getElementById('interfaceInfo');
            
            try {
                interfaceDiv.innerHTML = '<p>Storing interface data...</p>';
                
                const result = await InterfaceDisplayModule.storeInterfaceData(deviceIP);
                
                if (result.success) {
                    interfaceDiv.innerHTML = `<p class="status-online">${result.message}</p>`;
                    // Reload the stored data after storing
                    setTimeout(loadStoredInterfaceData, 1000);
                } else {
                    interfaceDiv.innerHTML = `<p class="error">${result.message}</p>`;
                }
                
            } catch (error) {
                console.error('Error storing interface data:', error);
                interfaceDiv.innerHTML = '<p class="error">Error storing interface data</p>';
            }
        }
        
        // Load stored interface data
        async function loadStoredInterfaceData() {
            if (!deviceIP) return;
            
            try {
                // First try to get combined interface data
                const response = await fetch('/get_combined_interfaces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip: deviceIP,
                        limit: 50
                    })
                });
                
                const data = await response.json();
                
                if (data.interfaces && data.interfaces.length > 0) {
                    displayCombinedInterfaceData(data.interfaces);
                } else {
                    // If no combined data, try to get SSH/CLI data only
                    loadSshCliDataOnly();
                }
                
            } catch (error) {
                console.error('Error loading stored interface data:', error);
            }
        }
        
        // Load SSH/CLI data only when no SNMP data available
        async function loadSshCliDataOnly() {
            try {
                const response = await fetch('/get_ssh_cli_interfaces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip: deviceIP,
                        limit: 50
                    })
                });
                
                const data = await response.json();
                
                if (data.interfaces && data.interfaces.length > 0) {
                    displaySshCliInterfaceData(data.interfaces);
                } else {
                    // Show message if no interface data found
                    const tbody = document.getElementById('interfaceTableBody');
                    const interfaceTable = document.getElementById('interfaceTable');
                    if (tbody && interfaceTable) {
                        tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 20px;">No interface data available. Please run an interface scan.</td></tr>';
                        interfaceTable.style.display = 'table';
                    }
                }
                
            } catch (error) {
                console.error('Error loading SSH/CLI data:', error);
            }
        }
        
        // Display SSH/CLI only interface data in table
        function displaySshCliInterfaceData(interfaces) {
            const tbody = document.getElementById('interfaceTableBody');
            const interfaceTable = document.getElementById('interfaceTable');
            
            if (!tbody || !interfaceTable) {
                console.error('Interface table elements not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            // Sort interfaces by port number (interface_index) from lowest to highest
            interfaces.sort((a, b) => a.interface_index - b.interface_index);
            
            interfaces.forEach(iface => {
                const row = tbody.insertRow();
                
                // Port number (convert from interface_index)
                const portNum = iface.interface_index > 10000 ? iface.interface_index - 10000 : iface.interface_index;
                row.insertCell(0).textContent = portNum;
                
                // Interface name
                row.insertCell(1).textContent = iface.interface_name || 'Unknown';
                
                // Type (from SSH/CLI data)
                row.insertCell(2).textContent = 'SSH/CLI';
                
                // Speed (from SSH/CLI data)
                let speedText = iface.speed || 'Unknown';
                row.insertCell(3).textContent = speedText;
                
                // Status (from SSH/CLI data)
                let statusCell = row.insertCell(4);
                let status = iface.status || 'unknown';
                if (status === 'up') {
                    statusCell.innerHTML = '<span class="status-online">Up</span>';
                } else if (status === 'down') {
                    statusCell.innerHTML = '<span class="status-offline">Down</span>';
                } else {
                    statusCell.innerHTML = '<span class="status-unknown">Unknown</span>';
                }
                
                // MAC Address (not available from SSH/CLI)
                row.insertCell(5).textContent = 'N/A';
                
                // RX/TX Bytes (not available from SSH/CLI)
                row.insertCell(6).textContent = 'N/A';
                row.insertCell(7).textContent = 'N/A';
                
                // Medium (from SSH/CLI)
                row.insertCell(8).textContent = iface.medium || 'Unknown';
                
                // Connector (from SSH/CLI)
                row.insertCell(9).textContent = iface.connector || 'Unknown';
                
                // TX Power (for optical interfaces)
                let txPowerCell = row.insertCell(10);
                if (iface.is_optical && iface.tx_power) {
                    txPowerCell.textContent = iface.tx_power;
                    txPowerCell.style.color = '#4CAF50';
                } else {
                    txPowerCell.textContent = iface.is_optical ? 'N/A' : '-';
                }
                
                // RX Power (for optical interfaces)
                let rxPowerCell = row.insertCell(11);
                if (iface.is_optical && iface.rx_power) {
                    rxPowerCell.textContent = iface.rx_power;
                    rxPowerCell.style.color = '#4CAF50';
                } else {
                    rxPowerCell.textContent = iface.is_optical ? 'N/A' : '-';
                }

                // Temperature (for optical interfaces)
                let tempCell = row.insertCell(12);
                if (iface.is_optical && iface.temperature) {
                    tempCell.textContent = iface.temperature;
                    tempCell.style.color = '#FF9800';
                } else {
                    tempCell.textContent = iface.is_optical ? 'N/A' : '-';
                }

                // LLDP neighbor summary (same row as port)
                const neighborSummaryParts = [];
                if (iface.lldp_remote_system_name) neighborSummaryParts.push(iface.lldp_remote_system_name);
                if (iface.lldp_remote_mgmt_addr) neighborSummaryParts.push('(' + iface.lldp_remote_mgmt_addr + ')');
                if (!neighborSummaryParts.length && iface.lldp_remote_chassis_id) neighborSummaryParts.push(iface.lldp_remote_chassis_id);

                const lldpNeighborCell = row.insertCell(13);
                lldpNeighborCell.textContent = neighborSummaryParts.length ? neighborSummaryParts.join(' ') : '-';
                if (iface.lldp_raw_info) {
                    lldpNeighborCell.title = iface.lldp_raw_info;
                }

                const lldpPortCell = row.insertCell(14);
                lldpPortCell.textContent = iface.lldp_remote_port || '-';
                
                // Optical History icon column
                let opticalIconCell = row.insertCell(15);
                if (iface.is_optical) {
                    opticalIconCell.innerHTML = 'ðŸ“Š';
                    opticalIconCell.className = 'optical-icon';
                    opticalIconCell.onclick = () => showOpticalHistory(deviceIP, iface.interface_index, iface.interface_name);
                    opticalIconCell.title = 'View optical power history';
                } else {
                    opticalIconCell.textContent = '-';
                }
                
                // Highlight optical interfaces
                if (iface.is_optical) {
                    row.style.backgroundColor = '#f0f8ff';
                }
            });
            
            interfaceTable.style.display = 'table';
            
            // Hide loading message
            const interfaceDiv = document.getElementById('interfaceInfo');
            if (interfaceDiv) {
                interfaceDiv.innerHTML = `<p class="status-online">Loaded ${interfaces.length} interfaces from SSH/CLI scan</p>`;
            }
        }
        
        // Display combined SNMP and SSH/CLI interface data in table
        function displayCombinedInterfaceData(interfaces) {
            const tbody = document.getElementById('interfaceTableBody');
            const interfaceTable = document.getElementById('interfaceTable');
            
            if (!tbody || !interfaceTable) {
                console.error('Interface table elements not found');
                return;
            }
            
            tbody.innerHTML = '';
            
            // Sort interfaces by port number (interface_index) from lowest to highest
            interfaces.sort((a, b) => a.interface_index - b.interface_index);
            
            interfaces.forEach(iface => {
                const row = tbody.insertRow();
                
                // Format speed with consistent alignment
                let speedText = '';
                if (iface.interface_speed === 4294967295) {
                    speedText = '10 Gbps';
                } else if (iface.interface_speed === 1000000000) {
                    speedText = ' 1 Gbps';
                } else if (iface.interface_speed === 0) {
                    speedText = 'No link';
                } else {
                    speedText = `${(iface.interface_speed / 1000000).toFixed(0).padStart(3)} Mbps`;
                }
                
                // Format status
                const statusText = iface.status || 'unknown';
                const statusClass = statusText.toLowerCase() === 'up' ? 'status-online' : 'status-offline';
                
                // Format traffic with consistent decimal alignment
                const rxGB = (iface.rx_bytes / 1000000000).toFixed(2).padStart(8);
                const txGB = (iface.tx_bytes / 1000000000).toFixed(2).padStart(8);
                
                // Format SSH/CLI data
                const portType = iface.is_optical ? 'Optical' : 'Electrical';
                const portTypeClass = iface.is_optical ? 'status-online' : 'status-offline';
                
                row.innerHTML = `
                    <td>${iface.interface_index}</td>
                    <td>${iface.interface_name}</td>
                    <td>${iface.interface_type_name}</td>
                    <td class="speed-align">${speedText}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>${iface.physical_address}</td>
                    <td class="bytes-align">${rxGB} GB</td>
                    <td class="bytes-align">${txGB} GB</td>
                    <td><span class="${portTypeClass}">${portType}</span></td>
                    <td>${iface.connector || '-'}</td>
                    <td class="power-align">${iface.tx_power || '-'}</td>
                    <td class="power-align">${iface.rx_power || '-'}</td>
                    <td class="power-align">${(iface.temperature && iface.temperature !== 'up' && iface.temperature !== 'down' && iface.temperature !== statusText) ? iface.temperature : (iface.is_optical ? 'N/A' : '-')}</td>
                    <td>${iface.lldp_remote_system_name || iface.lldp_remote_mgmt_addr || iface.lldp_remote_chassis_id || '-'}</td>
                    <td>${iface.lldp_remote_port || '-'}</td>
                    <td class="optical-icon">${iface.is_optical ? 'ðŸ“Š' : '-'}</td>
                `;
                
                // Add click handler for optical interfaces
                if (iface.is_optical) {
                    const opticalCell = row.cells[15];
                    opticalCell.onclick = () => showOpticalHistory(deviceIP, iface.interface_index, iface.interface_name);
                    opticalCell.title = 'View optical power history';
                }
            });
            
            interfaceTable.style.display = 'table';
        }
        
        // Refresh data
        function refreshData() {
            loadDeviceData();
        }
        
        // Show optical power history modal
        async function showOpticalHistory(ip, interfaceIndex, interfaceName) {
            // Store current interface info
            currentOpticalInterface = {
                ip: ip,
                interfaceIndex: interfaceIndex,
                interfaceName: interfaceName
            };
            
            document.getElementById('modalTitle').textContent = `Optical Power History - ${interfaceName} (${ip})`;
            document.getElementById('opticalModal').style.display = 'block';
            
            // Load with default 24 hours
            loadOpticalHistory(24);
        }
        
        // Load optical history with specified hours
        async function loadOpticalHistory(hours) {
            if (!currentOpticalInterface) return;
            
            try {
                // Fetch power history for this specific interface
                const response = await fetch('/power_history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ip_addresses: [currentOpticalInterface.ip],
                        interface_index: currentOpticalInterface.interfaceIndex,
                        hours: hours
                    })
                });
                
                const data = await response.json();
                
                if (data.history && data.history.length > 0) {
                    displayOpticalChart(data.history, hours);
                    displayOpticalTable(data.history);
                } else {
                    document.getElementById('powerDataTableBody').innerHTML = 
                        '<tr><td colspan="4" style="text-align: center;">No power history data available</td></tr>';
                    // Clear chart
                    const ctx = document.getElementById('opticalChart').getContext('2d');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                }
                
            } catch (error) {
                console.error('Error loading optical power history:', error);
                document.getElementById('powerDataTableBody').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: red;">Error loading power history data</td></tr>';
            }
        }
        
        // Close optical modal
        function closeOpticalModal() {
            document.getElementById('opticalModal').style.display = 'none';
            currentOpticalInterface = null;
        }
        
        // Display optical power chart
        function displayOpticalChart(history, hours) {
            const ctx = document.getElementById('opticalChart').getContext('2d');
            
            // Sort by timestamp
            history.sort((a, b) => new Date(a.measurement_timestamp) - new Date(b.measurement_timestamp));
            
            const labels = history.map(h => new Date(h.measurement_timestamp));
            const txData = history.map(h => h.tx_power);
            const rxData = history.map(h => h.rx_power);
            const tempData = history.map(h => h.temperature);
            
            // Check if we have temperature data
            const hasTempData = tempData.some(t => t !== null && t !== undefined);
            
            // Destroy existing chart if it exists
            if (window.opticalChartInstance) {
                window.opticalChartInstance.destroy();
            }
            
            // Build datasets
            const datasets = [
                {
                    label: 'TX Power',
                    data: txData,
                    borderColor: '#007bff',
                    backgroundColor: '#007bff20',
                    borderWidth: 2,
                    pointRadius: 4,
                    tension: 0.1,
                    yAxisID: 'y'
                },
                {
                    label: 'RX Power',
                    data: rxData,
                    borderColor: '#28a745',
                    backgroundColor: '#28a74520',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 4,
                    tension: 0.1,
                    yAxisID: 'y'
                }
            ];
            
            // Add temperature dataset if available
            if (hasTempData) {
                datasets.push({
                    label: 'Temperature',
                    data: tempData,
                    borderColor: '#dc3545',
                    backgroundColor: '#dc354520',
                    borderWidth: 2,
                    pointRadius: 4,
                    tension: 0.1,
                    yAxisID: 'y1'
                });
            }
            
            // Configure scales
            const scales = {
                x: {
                    type: 'time',
                    time: {
                        displayFormats: {
                            minute: 'MMM dd HH:mm',
                            hour: 'MMM dd HH:mm',
                            day: 'MMM dd HH:mm',
                            week: 'MMM dd HH:mm',
                            month: 'MMM dd HH:mm',
                            quarter: 'MMM dd HH:mm',
                            year: 'MMM dd HH:mm'
                        },
                        tooltipFormat: 'MMM dd, yyyy HH:mm'
                    },
                    title: {
                        display: true,
                        text: 'Time (24-hour format)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Power (dBm)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' dBm';
                        }
                    }
                }
            };
            
            // Add temperature axis if we have temperature data
            if (hasTempData) {
                scales.y1 = {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Temperature (Â°C)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' Â°C';
                        }
                    },
                    grid: {
                        drawOnChartArea: false, // only draw grid for left axis
                    }
                };
            }
            
            window.opticalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: hasTempData ? 'Optical Power Levels & Temperature' : 'Optical Power Levels'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: scales
                }
            });
        }
        
        // Display optical power data table
        function displayOpticalTable(history) {
            const tbody = document.getElementById('powerDataTableBody');
            tbody.innerHTML = '';
            
            // Sort by timestamp (newest first)
            history.sort((a, b) => new Date(b.measurement_timestamp) - new Date(a.measurement_timestamp));
            
            history.forEach(reading => {
                const row = tbody.insertRow();
                // Format timestamp in 24-hour format
                const timestamp = new Date(reading.measurement_timestamp);
                const formattedTimestamp = timestamp.toLocaleString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                const txPower = reading.tx_power ? reading.tx_power.toFixed(2) : 'N/A';
                const rxPower = reading.rx_power ? reading.rx_power.toFixed(2) : 'N/A';
                const temp = reading.temperature ? reading.temperature.toFixed(1) : 'N/A';
                
                row.innerHTML = `
                    <td>${formattedTimestamp}</td>
                    <td class="numeric">${txPower}</td>
                    <td class="numeric">${rxPower}</td>
                    <td class="numeric">${temp}</td>
                `;
            });
        }
        
        // Load data when page opens
        window.onload = function() {
            loadDeviceData();
            // Load combined interface data after a delay
            setTimeout(loadStoredInterfaceData, 2000);
        }
    </script>
</body>
</html>
